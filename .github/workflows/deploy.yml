name: Deploy

run-name: Deploy to ${{ github.event.inputs.environment || (github.ref_name == 'main' && 'Production') || 'Staging' }}

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
      - develop

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Determine which environment to deploy based on branch or input
  setup:
    name: Setup Deployment
    runs-on: ubuntu-latest
    # Only run if CI succeeded (for workflow_run) or if manually triggered
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          # Get the branch name from workflow_run event or current ref
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "$BRANCH" == "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "image_tag=production" >> $GITHUB_OUTPUT
          elif [ "$BRANCH" == "develop" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "image_tag=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=none" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "image_tag=none" >> $GITHUB_OUTPUT
          fi

  # Build and push Docker images
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_deploy == 'true'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        app:
          - name: client
            dockerfile: apps/client/Dockerfile
            context: .
          - name: strapi
            dockerfile: apps/strapi/Dockerfile
            context: .
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.app.name }}
          tags: |
            type=sha,prefix=${{ needs.setup.outputs.environment }}-
            type=raw,value=${{ needs.setup.outputs.environment }}
            type=raw,value=${{ needs.setup.outputs.environment }}-${{ github.run_number }}
            type=raw,value=latest,enable=${{ github.ref_name == 'main' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.app.context }}
          file: ${{ matrix.app.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # Deploy to Dokploy - Client
  deploy-client:
    name: Deploy Client (${{ needs.setup.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [setup, build-and-push]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Deploy to Dokploy
        run: |
          # Trigger deployment via Dokploy API
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.DOKPLOY_URL }}/api/application.deploy" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"applicationId": "${{ secrets.DOKPLOY_CLIENT_APP_ID }}"}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Code: $http_code"

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "‚úÖ Client deployment triggered for ${{ needs.setup.outputs.environment }}"
          else
            echo "‚ùå Failed to trigger client deployment"
            exit 1
          fi

  # Deploy to Dokploy - Strapi
  deploy-strapi:
    name: Deploy Strapi (${{ needs.setup.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [setup, build-and-push]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Deploy to Dokploy
        run: |
          # Trigger deployment via Dokploy API
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.DOKPLOY_URL }}/api/application.deploy" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"applicationId": "${{ secrets.DOKPLOY_STRAPI_APP_ID }}"}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Code: $http_code"

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "‚úÖ Strapi deployment triggered for ${{ needs.setup.outputs.environment }}"
          else
            echo "‚ùå Failed to trigger Strapi deployment"
            exit 1
          fi

  # Summary
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [setup, deploy-client, deploy-strapi]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.setup.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-client.result }}" == "success" ]; then
            echo "‚úÖ Client: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Client: Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-strapi.result }}" == "success" ]; then
            echo "‚úÖ Strapi: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Strapi: Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-client.result }}" == "success" ] && [ "${{ needs.deploy-strapi.result }}" == "success" ]; then
            echo ""
            echo "üöÄ All deployments completed successfully!"
          else
            echo ""
            echo "‚ö†Ô∏è Some deployments failed. Check the logs above."
            exit 1
          fi
